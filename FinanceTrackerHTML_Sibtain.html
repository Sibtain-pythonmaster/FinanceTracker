<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Personal Finance Tracker</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-r from-blue-100 to-blue-200 text-gray-900">
<div class="max-w-6xl mx-auto p-6 space-y-6">
<h1 class="text-4xl font-bold text-center mb-4">ğŸ’° Finance Tracker v3.0 â€” â€œThe Complete Editionâ€ By Sibtain</h1>
<p class="text-center text-lg text-gray-700 max-w-2xl mx-auto">
Track your deposits, expenses, recurring bills, and savings goalsâ€”all in one place.
Visualize your spending with charts, and manage your money smarter. ğŸ’¼ Updates most Mondays. Alsoâ€¦ coffee ğŸ‘‡
</p>

<div class="grid md:grid-cols-2 gap-6">
    <div id="netWorthCard" class="p-6 bg-white rounded-2xl shadow-md text-center">
        <h2 class="text-xl font-semibold">ğŸ’ Net Worth</h2>
        <p id="netWorth" class="text-3xl font-bold mt-2 text-indigo-600">$0.00</p>
    </div>
    <div id="balanceCard" class="p-6 bg-white rounded-2xl shadow-md text-center transition">
        <h2 class="text-xl font-semibold">ğŸ¦ Liquid Balance</h2>
        <p id="balance" class="text-3xl font-bold mt-2">$0.00</p>
    </div>
</div>

<div class="grid md:grid-cols-2 gap-6">
    <div class="p-4 bg-white rounded-2xl shadow-md">
        <h2 class="font-semibold text-lg mb-2">ğŸŸ¢ Assets</h2>
        <form id="assetForm" class="flex gap-2 mb-2">
            <input type="text" placeholder="Asset Name (e.g., Savings)" class="w-2/3 border rounded-lg p-2" required>
            <input type="number" step="0.01" min="0" placeholder="Amount" class="w-1/3 border rounded-lg p-2" required>
            <button class="bg-green-500 text-white rounded-lg p-2 hover:bg-green-600">Add</button>
        </form>
        <ul id="assetList" class="space-y-1 text-green-700"></ul>
    </div>
    <div class="p-4 bg-white rounded-2xl shadow-md">
        <h2 class="font-semibold text-lg mb-2">ğŸ”´ Liabilities</h2>
        <form id="liabilityForm" class="flex gap-2 mb-2">
            <input type="text" placeholder="Liability Name (e.g., Loan)" class="w-2/3 border rounded-lg p-2" required>
            <input type="number" step="0.01" min="0" placeholder="Amount" class="w-1/3 border rounded-lg p-2" required>
            <button class="bg-red-500 text-white rounded-lg p-2 hover:bg-red-600">Add</button>
        </form>
        <ul id="liabilityList" class="space-y-1 text-red-700"></ul>
    </div>
</div>

<div class="p-4 bg-white rounded-2xl shadow-md text-center space-x-2">
<h2 class="font-semibold text-lg mb-2">âš¡ Quick Add Expense</h2>
<button onclick="quickAdd('Coffee', 5, 'Starbucks coffee')" class="bg-orange-400 text-white px-3 py-1 rounded hover:bg-orange-500">â˜• Coffee - $5</button>
<button onclick="quickAdd('Lunch', 12, 'Lunch combo')" class="bg-orange-400 text-white px-3 py-1 rounded hover:bg-orange-500">ğŸ” Lunch - $12</button>
<button onclick="quickAdd('Transport', 10, 'Bus fare')" class="bg-orange-400 text-white px-3 py-1 rounded hover:bg-orange-500">ğŸšŒ Transport - $10</button>
</div>

<div class="p-4 bg-white rounded-2xl shadow-md">
<h2 class="text-lg font-semibold mb-2">ğŸ“Š Spending vs Savings</h2>
<div class="w-full bg-gray-200 rounded-full h-4">
<div id="progressBar" class="h-4 rounded-full transition-all duration-500" style="width: 100%"></div>
</div>
</div>

<div class="p-4 bg-white rounded-2xl shadow-md">
    <label class="block text-center font-semibold text-lg mb-2">ğŸ¤– Smart Add Command</label>
    <input id="smartAddInput" type="text" placeholder='Try: "coffee $5" or "deposit paycheck $1000" or "goal vacation $2000"' class="w-full border rounded-lg p-2 mb-2 text-center">
    <button onclick="smartAddLine()" class="w-full bg-indigo-500 text-white rounded-lg p-2 hover:bg-indigo-600">Add from Text</button>
</div>


<div class="grid md:grid-cols-2 gap-6">
<div class="p-4 bg-white rounded-2xl shadow-md">
<h2 class="font-semibold text-lg mb-2">â• Add Deposit</h2>
<form id="depositForm" class="space-y-2">
<input type="number" step="0.01" min="0" placeholder="Amount" class="w-full border rounded-lg p-2" required>
<input type="text" placeholder="Description (optional)" class="w-full border rounded-lg p-2">
<button class="w-full bg-green-500 text-white rounded-lg p-2 hover:bg-green-600">Add Deposit</button>
</form>
</div>

<div class="p-4 bg-white rounded-2xl shadow-md">
<h2 class="font-semibold text-lg mb-2">ğŸ’¸ Add Expense</h2>
<form id="expenseForm" class="space-y-2">
<input id="expenseDesc" type="text" placeholder="Description (e.g., Starbucks coffee)" class="w-full border rounded-lg p-2">
<div class="grid grid-cols-2 gap-2">
<input id="expenseCategory" type="text" placeholder="Category (auto if blank)" class="w-full border rounded-lg p-2">
<input id="expenseAmount" type="number" step="0.01" min="0" placeholder="Amount" class="w-full border rounded-lg p-2" required>
</div>
<label class="flex items-center space-x-2">
<input type="checkbox" id="recurringExpense" class="h-4 w-4">
<span>Make this a recurring monthly expense</span>
</label>
<button class="w-full bg-red-500 text-white rounded-lg p-2 hover:bg-red-600">Add Expense</button>
</form>
</div>
</div>

<div class="p-4 bg-white rounded-2xl shadow-md flex flex-wrap gap-3 justify-center">
<select id="sortSelect" class="border rounded-lg p-2">
<option value="newest">Sort by: Newest</option>
<option value="oldest">Oldest</option>
<option value="amount">Amount</option>
</select>
<input id="filterCategory" type="text" placeholder="Filter by category..." class="border rounded-lg p-2">
<button onclick="updateUI()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Apply</button>
</div>

<div class="p-4 bg-white rounded-2xl shadow-md">
    <h2 class="font-semibold text-lg mb-2">ğŸ“œ All Transactions</h2>
    <ul id="transactionList" class="space-y-1 text-gray-800"></ul>
    <div id="transactionTotals" class="mt-4 pt-2 border-t border-gray-200 flex justify-between font-bold">
        </div>
</div>


<div class="grid md:grid-cols-2 gap-6">
<div class="p-4 bg-white rounded-2xl shadow-md">
<h2 class="font-semibold text-lg mb-2">ğŸ“ˆ Deposits</h2>
<ul id="depositList" class="space-y-1 text-green-600"></ul>
</div>
<div class="p-4 bg-white rounded-2xl shadow-md">
<h2 class="font-semibold text-lg mb-2">ğŸ’¸ Expenses</h2>
<ul id="expenseList" class="space-y-1 text-red-600"></ul>
</div>
</div>
<div class="p-4 bg-white rounded-2xl shadow-md">
<h2 class="font-semibold text-lg mb-2">ğŸ¤– Smart Insights</h2>
<div id="assistantInsights" class="space-y-2 text-gray-800">
<p class="text-sm text-gray-500">Insights will appear as you add data.</p>
</div>
</div>

<div class="p-4 bg-white rounded-2xl shadow-md">
<h2 class="font-semibold text-lg mb-2">ğŸ” Recurring Monthly Expenses</h2>
<ul id="recurringList" class="space-y-1 text-purple-600"></ul>
</div>

<div class="p-4 bg-white rounded-2xl shadow-md">
<h2 class="font-semibold text-lg mb-2">ğŸ§® Totals by Category</h2>
<ul id="categoryTotals" class="space-y-1"></ul>
</div>

<div class="grid md:grid-cols-2 gap-6">
    <div class="p-4 bg-white rounded-2xl shadow-md">
        <h2 class="text-lg font-semibold mb-2">ğŸ’ Net Worth Trend</h2>
        <canvas id="netWorthChart" height="150"></canvas>
        <button onclick="logNetWorth()" class="w-full mt-2 bg-indigo-500 text-white rounded-lg p-2 hover:bg-indigo-600">Log Current Net Worth</button>
    </div>
    <div class="p-4 bg-white rounded-2xl shadow-md">
        <h2 class="text-lg font-semibold mb-2">ğŸ“Š Expenses by Category</h2>
        <canvas id="expenseChart" height="150"></canvas>
    </div>
</div>
<div class="p-4 bg-white rounded-2xl shadow-md">
<h2 class="text-lg font-semibold mb-2">ğŸ“… Monthly Spending Trend</h2>
<canvas id="monthlyChart" height="150"></canvas>
</div>


<div class="p-4 bg-white rounded-2xl shadow-md">
<h2 class="font-semibold text-lg mb-2">ğŸ¯ Savings Goal</h2>
<form id="goalForm" class="space-y-2 mb-4">
<input type="text" placeholder="Goal Name (e.g., Laptop)" class="w-full border rounded-lg p-2" required>
<input type="number" step="0.01" min="1" placeholder="Goal Amount" class="w-full border rounded-lg p-2" required>
<button class="w-full bg-blue-500 text-white rounded-lg p-2 hover:bg-blue-600">Set Goal</button>
</form>

<div id="goalArea" class="hidden">
<p class="font-semibold">Goal: <span id="goalName"></span> - $<span id="goalAmount"></span></p>
<div class="w-full bg-gray-200 rounded-full h-4 mt-2">
<div id="goalProgress" class="bg-blue-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
</div>
<p class="text-sm mt-1">Progress: <span id="goalPercent">0</span>%</p>
<p id="goalStatus" class="text-green-600 font-semibold mt-2 hidden">ğŸ‰ Goal Reached!</p>
</div>
</div>



<div class="text-center space-x-4">
<button id="resetBtn" class="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500">â™»ï¸ Reset All Data</button>
<button id="exportBtn" class="bg-blue-400 text-white px-4 py-2 rounded-lg hover:bg-blue-500">ğŸ“¤ Export</button>
<input type="file" id="importFile" class="hidden" accept="application/json">
<label for="importFile" class="bg-blue-500 text-white px-4 py-2 rounded-lg cursor-pointer hover:bg-blue-600">ğŸ“¥ Import</label>
<a href="https://buymeacoffee.com/sibtainsalw" target="_blank" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600">â˜• Buy me Coffee!</a>
</div>
</div>

<script>
// ===== STATE (with safe upgrade) =====
let state = JSON.parse(localStorage.getItem("financeData")) || {
    balance: 0,
    deposits: [],
    expenses: [],
    recurring: [],
    goal: { name: "", amount: 0 },
    assets: [],
    liabilities: [],
    netWorthHistory: [],
    lastAppliedMonth: null,
    lastBackupMonth: null
};
// normalize legacy records
state.deposits = (state.deposits || []).map(d => ({ amount: d.amount, date: d.date || todayISO(), description: d.description || "" }));
state.expenses = (state.expenses || []).map(e => ({ category: e.category || "", amount: e.amount, date: e.date || todayISO(), description: e.description || "" }));
if (!state.recurring) state.recurring = [];
if (!state.assets) state.assets = [];
if (!state.liabilities) state.liabilities = [];
if (!state.netWorthHistory) state.netWorthHistory = [];
if (!state.lastAppliedMonth) state.lastAppliedMonth = null;
if (!state.lastBackupMonth) state.lastBackupMonth = null;

// ===== ELEMENTS =====
const balanceEl = document.getElementById("balance");
const balanceCard = document.getElementById("balanceCard");
const progressBar = document.getElementById("progressBar");
const depositList = document.getElementById("depositList");
const expenseList = document.getElementById("expenseList");
const transactionList = document.getElementById("transactionList");
const transactionTotals = document.getElementById("transactionTotals");
const recurringList = document.getElementById("recurringList");
const categoryTotals = document.getElementById("categoryTotals");
const assistantInsights = document.getElementById("assistantInsights");
// Net Worth Elements
const netWorthEl = document.getElementById("netWorth");
const assetList = document.getElementById("assetList");
const liabilityList = document.getElementById("liabilityList");
// Chart Elements
const expenseChartCtx = document.getElementById("expenseChart").getContext("2d");
const monthlyChartCtx = document.getElementById("monthlyChart").getContext("2d");
const netWorthChartCtx = document.getElementById("netWorthChart").getContext("2d");
// Goal Elements
const goalForm = document.getElementById("goalForm");
const goalArea = document.getElementById("goalArea");
const goalNameEl = document.getElementById("goalName");
const goalAmountEl = document.getElementById("goalAmount");
const goalProgress = document.getElementById("goalProgress");
const goalPercentEl = document.getElementById("goalPercent");
const goalStatus = document.getElementById("goalStatus");

// ===== CHARTS =====
const expenseChart = new Chart(expenseChartCtx, {
    type: 'pie',
    data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
});

const monthlyChart = new Chart(monthlyChartCtx, {
    type: 'bar',
    data: { labels: [], datasets: [
        { label: 'Deposits', data: [], backgroundColor: 'rgba(75,192,192,0.6)' },
        { label: 'Expenses', data: [], backgroundColor: 'rgba(255,99,132,0.6)' }
    ]},
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
});

const netWorthChart = new Chart(netWorthChartCtx, {
    type: 'line',
    data: { labels: [], datasets: [{ 
        label: 'Net Worth', 
        data: [], 
        borderColor: 'rgba(75, 192, 192, 1)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        fill: true,
        tension: 0.1 
    }] },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
});

// ===== HELPERS =====
function save() {
    const currentMonth = currentMonthKey();
    if (state.lastBackupMonth !== currentMonth) {
        console.log(`Performing monthly backup for ${currentMonth}...`);
        const blob = new Blob([JSON.stringify(state)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `financeData_backup_${currentMonth}.json`;
        a.click();
        URL.revokeObjectURL(url);
        state.lastBackupMonth = currentMonth;
    }
    localStorage.setItem("financeData", JSON.stringify(state));
}

function monthKey(dstr) {
    if (/^\d{4}-\d{2}-\d{2}$/.test(dstr)) return dstr.slice(0,7);
    const d = new Date(dstr);
    if (!isNaN(d)) return d.toISOString().slice(0,7);
    return new Date().toISOString().slice(0,7);
}
function currentMonthKey() { return new Date().toISOString().slice(0,7); }
function todayISO() { return new Date().toISOString().slice(0,10); }

// ===== LIGHTWEIGHT AI CATEGORIZER =====
const CATEGORY_RULES = [
    { cat: "Food", keys: ["starbucks","coffee","cafe","restaurant","mcdonald","burger","pizza","chipotle","lunch","dinner","grocer","supermarket"] },
    { cat: "Transport", keys: ["uber","lyft","shell","exxon","bp","gas","fuel","bus","train","metro","toll","parking"] },
    { cat: "Bills", keys: ["utility","electric","water","internet","wifi","phone","mobile","verizon","att","t-mobile","rent","mortgage","insurance"] },
    { cat: "Shopping", keys: ["amazon","walmart","target","clothes","shoes","apparel","store","mall","costco","best buy"] },
    { cat: "Entertainment", keys: ["netflix","spotify","disney","movie","cinema","game","xbox","playstation","hulu","concert"] },
    { cat: "Health", keys: ["pharmacy","cvs","walgreens","doctor","dentist","clinic","gym","fitness","workout","protein"] },
    { cat: "Education", keys: ["book","tuition","course","udemy","coursera","textbook","school","class"] },
    { cat: "Travel", keys: ["hotel","airbnb","flight","plane","airline","airport","uber","car rental"] },
];
function autoCategoryFromText(text) {
    if (!text) return "";
    const t = text.toLowerCase();
    for (const rule of CATEGORY_RULES) {
        if (rule.keys.some(k => t.includes(k))) return rule.cat;
    }
    return "";
}

// ===== NET WORTH =====
function calculateNetWorth() {
    const totalAssets = state.assets.reduce((sum, asset) => sum + asset.amount, state.balance);
    const totalLiabilities = state.liabilities.reduce((sum, liability) => sum + liability.amount, 0);
    return totalAssets - totalLiabilities;
}

function logNetWorth() {
    const today = todayISO();
    const currentNetWorth = calculateNetWorth();
    const lastLog = state.netWorthHistory[state.netWorthHistory.length - 1];
    if (lastLog && lastLog.date === today) {
        if(!confirm("You already logged your net worth today. Log again?")) return;
    }
    state.netWorthHistory.push({ date: today, amount: currentNetWorth });
    state.netWorthHistory.sort((a,b) => new Date(a.date) - new Date(b.date));
    updateUI();
}

// ===== RECURRING =====
function applyRecurringExpenses() {
    const currentMonth = currentMonthKey();
    if (state.lastAppliedMonth === currentMonth) return;
    state.recurring.forEach(r => {
        state.balance -= r.amount;
        state.expenses.push({ category: r.category + " (recurring)", amount: r.amount, date: todayISO(), description: r.description || "Recurring" });
    });
    state.lastAppliedMonth = currentMonth;
    save();
}

function updateRecurringList() {
    recurringList.innerHTML = state.recurring.length
        ? state.recurring.map((r, i) => `<li>ğŸ” ${r.category}: -$${r.amount.toFixed(2)} / month <button onclick="deleteRecurring(${i})" class="text-xs text-red-500 ml-2">âŒ</button></li>`).join("")
        : "<li>No recurring expenses yet.</li>";
}
function deleteRecurring(i){
    state.recurring.splice(i,1);
    save();
    updateUI();
}

// ===== UI =====
function updateUI() {
    // NET WORTH SECTION
    netWorthEl.textContent = `$${calculateNetWorth().toFixed(2)}`;
    assetList.innerHTML = state.assets.map((a, i) => `<li>- ${escapeHtml(a.name)}: $${a.amount.toFixed(2)} <button onclick="deleteAsset(${i})" class="text-xs text-red-500 ml-2">âŒ</button></li>`).join("");
    liabilityList.innerHTML = state.liabilities.map((l, i) => `<li>- ${escapeHtml(l.name)}: $${l.amount.toFixed(2)} <button onclick="deleteLiability(${i})" class="text-xs text-red-500 ml-2">âŒ</button></li>`).join("");
    netWorthChart.data.labels = state.netWorthHistory.map(h => h.date);
    netWorthChart.data.datasets[0].data = state.netWorthHistory.map(h => h.amount);
    netWorthChart.update();
    
    // Sorting & filtering for display lists
    const sortType = document.getElementById("sortSelect").value;
    const filterText = (document.getElementById("filterCategory").value || "").toLowerCase();
    let filteredExpenses = [...state.expenses].filter(e => filterText ? (e.category || "").toLowerCase().includes(filterText) : true);
    if (sortType === "amount") filteredExpenses.sort((a,b) => b.amount - a.amount);
    else if (sortType === "oldest") filteredExpenses.sort((a,b) => new Date(a.date) - new Date(b.date));
    else filteredExpenses.sort((a,b) => new Date(b.date) - new Date(a.date));

    // Balance + color
    balanceEl.textContent = `$${state.balance.toFixed(2)}`;
    balanceCard.className = "p-6 bg-white rounded-2xl shadow-md text-center transition ";
    if (state.balance > 100) balanceCard.classList.add("bg-green-100");
    else if (state.balance >= 0) balanceCard.classList.add("bg-yellow-100");
    else balanceCard.classList.add("bg-red-100");

    // COMBINED TRANSACTION LIST
    const allTransactions = [
        ...state.deposits.map(d => ({...d, type: 'deposit'})),
        ...state.expenses.map(e => ({...e, type: 'expense'}))
    ].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    transactionList.innerHTML = allTransactions.length ? allTransactions.map(t => {
        if (t.type === 'deposit') {
            return `<li>(${t.date}) ${escapeHtml(t.description) || 'Deposit'} <span class="font-bold text-green-600 float-right">+$${t.amount.toFixed(2)}</span></li>`;
        } else {
            const desc = `${escapeHtml(t.category)}: ${escapeHtml(t.description)}`;
            return `<li>(${t.date}) ${desc || 'Expense'} <span class="font-bold text-red-600 float-right">-$${t.amount.toFixed(2)}</span></li>`;
        }
    }).join('') : '<li>No transactions yet.</li>';

    // Transaction Totals
    const totalAllDeposits = state.deposits.reduce((sum, d) => sum + d.amount, 0);
    const totalAllExpenses = state.expenses.reduce((sum, e) => sum + e.amount, 0);
    transactionTotals.innerHTML = `
        <span class="text-green-600">Total Deposits: +$${totalAllDeposits.toFixed(2)}</span>
        <span class="text-red-600">Total Expenses: -$${totalAllExpenses.toFixed(2)}</span>
    `;

    // Deposit & Expense lists (separate)
    depositList.innerHTML = state.deposits.map((d, i) => `<li>ğŸ’° +$${d.amount.toFixed(2)} (${d.date}) ${d.description ? "â€” " + escapeHtml(d.description) : ""} <button onclick="editDeposit(${i})" class='text-xs text-blue-500 ml-2'>âœï¸</button> <button onclick="deleteDeposit(${i})" class='text-xs text-red-500 ml-1'>âŒ</button></li>`).join("");
    expenseList.innerHTML = filteredExpenses.map((e, i) => `<li class="animate-fadeIn">ğŸ’¸ ${e.category || "Uncategorized"}: -$${e.amount.toFixed(2)} (${e.date}) ${e.description ? "â€” " + escapeHtml(e.description) : ""} <button onclick="editExpense(${i})" class='text-xs text-blue-500 ml-2'>âœï¸</button> <button onclick="deleteExpense(${i})" class='text-xs text-red-500 ml-1'>âŒ</button></li>`).join("");

    // Category totals
    const catTotals = state.expenses.reduce((acc, e) => {
        const c = e.category || "Uncategorized";
        acc[c] = (acc[c] || 0) + e.amount;
        return acc;
    }, {});
    categoryTotals.innerHTML = Object.entries(catTotals).map(([cat, amt]) => `<li>${escapeHtml(cat)}: $${amt.toFixed(2)}</li>`).join("") || "<li>No data yet.</li>";

    // Pie chart
    expenseChart.data.labels = Object.keys(catTotals);
    expenseChart.data.datasets[0].data = Object.values(catTotals);
    expenseChart.data.datasets[0].backgroundColor = Object.keys(catTotals).map((_, i) => `hsl(${i * 50},70%,60%)`);
    expenseChart.update();

    // Monthly bar chart
    const months = {};
    [...state.expenses, ...state.deposits].forEach(t => {
        const m = monthKey(t.date);
        if (!months[m]) months[m] = {exp:0, dep:0};
        months[m][t.category ? 'exp' : 'dep'] += t.amount;
    });
    const labels = Object.keys(months).sort();
    monthlyChart.data.labels = labels;
    monthlyChart.data.datasets[0].data = labels.map(m => months[m].dep);
    monthlyChart.data.datasets[1].data = labels.map(m => months[m].exp);
    monthlyChart.update();

    // Progress bar
    const totalProgressBarDeposits = state.deposits.reduce((a, b) => a + b.amount, 0);
    const totalProgressBarExpenses = state.expenses.reduce((a, b) => a + b.amount, 0);
    const percent = totalProgressBarDeposits > 0 ? Math.max(0, ((totalProgressBarDeposits - totalProgressBarExpenses) / totalProgressBarDeposits) * 100) : 100;
    progressBar.style.width = percent + "%";
    progressBar.className = "h-4 rounded-full transition-all duration-500 " + (percent > 50 ? "bg-green-500" : percent > 20 ? "bg-yellow-500" : "bg-red-500");

    updateGoalUI();
    updateAssistant();
    updateRecurringList();
    save();
}

function updateGoalUI() {
    if (state.goal.amount > 0) {
        goalArea.classList.remove("hidden");
        goalNameEl.textContent = state.goal.name;
        goalAmountEl.textContent = state.goal.amount.toFixed(2);
        const percent = Math.min(100, (state.balance / state.goal.amount) * 100);
        goalProgress.style.width = percent + "%";
        goalPercentEl.textContent = percent.toFixed(1);
        goalStatus.classList.toggle("hidden", state.balance < state.goal.amount);
    } else {
        goalArea.classList.add("hidden");
    }
}

// ===== SMART ASSISTANT =====
function updateAssistant() {
    const month = currentMonthKey();
    const monthCat = state.expenses.filter(e => monthKey(e.date) === month).reduce((acc, e) => {
        const c = e.category || "Uncategorized";
        acc[c] = (acc[c] || 0) + e.amount;
        return acc;
    }, {});

    const topSpend = Object.entries(monthCat).sort((a,b) => b[1]-a[1])[0];
    let suggestionHTML = "";
    if (topSpend) {
        const [topCat, topAmt] = topSpend;
        const suggestedCut = topAmt >= 250 ? 50 : (topAmt >= 100 ? 25 : 10);
        suggestionHTML = `<li>ğŸ’¡ You spent <b>$${topAmt.toFixed(2)}</b> on <b>${escapeHtml(topCat)}</b> this month. Consider reducing by <b>$${suggestedCut}</b>.</li>`;
    }

    let forecastHTML = "";
    if (state.goal.amount > 0 && state.balance < state.goal.amount) {
        const remaining = state.goal.amount - state.balance;
        const weeklyNet = averageWeeklyNet(4);
        if (weeklyNet > 0) {
            const weeks = Math.ceil(remaining / weeklyNet);
            forecastHTML = `<li>ğŸ“ˆ At your recent pace (~$${weeklyNet.toFixed(0)}/week), you'll reach your <b>${escapeHtml(state.goal.name)}</b> goal in about <b>${weeks} week${weeks>1?'s':''}</b>.</li>`;
        } else {
            forecastHTML = `<li>âš ï¸ Your recent weekly net is not positive. Increase savings or cut spending to reach your goal.</li>`;
        }
    }
    
    if (!suggestionHTML && !forecastHTML) {
        assistantInsights.innerHTML = `<p class="text-sm text-gray-500">Add data to see insights.</p>`;
        return;
    }
    assistantInsights.innerHTML = `<ul class="list-disc pl-5 space-y-1">${suggestionHTML}${forecastHTML}</ul>`;
}

function averageWeeklyNet(weeksBack = 4) {
    const start = new Date(Date.now() - weeksBack * 7 * 24 * 60 * 60 * 1000);
    const inRange = dateStr => new Date(dateStr) >= start;
    const dep = state.deposits.reduce((s, d) => s + (inRange(d.date) ? d.amount : 0), 0);
    const exp = state.expenses.reduce((s, e) => s + (inRange(e.date) ? e.amount : 0), 0);
    return (dep - exp) / Math.max(1, weeksBack);
}

function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
}

// ===== CRUD + FORMS =====
function deleteDeposit(i){ state.balance -= state.deposits.splice(i,1)[0].amount; updateUI(); }
function deleteExpense(i){ state.balance += state.expenses.splice(i,1)[0].amount; updateUI(); }
function deleteAsset(i){ state.assets.splice(i,1); updateUI(); }
function deleteLiability(i){ state.liabilities.splice(i,1); updateUI(); }

function editDeposit(i){
    const v = prompt("Edit deposit amount:", state.deposits[i].amount);
    if (v !== null && !isNaN(parseFloat(v))) {
        state.balance += parseFloat(v) - state.deposits[i].amount;
        state.deposits[i].amount = parseFloat(v);
        updateUI();
    }
}
function editExpense(i){
    const v = prompt("Edit expense amount:", state.expenses[i].amount);
    if (v !== null && !isNaN(parseFloat(v))) {
        state.balance += state.expenses[i].amount - parseFloat(v);
        state.expenses[i].amount = parseFloat(v);
        updateUI();
    }
}

function quickAdd(category, amount, description="") {
    state.balance -= amount;
    state.expenses.push({ category, amount, date: todayISO(), description });
    updateUI();
}

function smartAddLine() {
    const input = document.getElementById("smartAddInput");
    const line = (input.value || "").trim();
    if (!line) return;
    const match = line.match(/\$\s*(\d+(\.\d{1,2})?)\s*$/);
    if (!match) { alert("Input must include a dollar sign ($) and an amount."); return; }
    
    const amount = parseFloat(match[1]);
    const text = line.replace(match[0], "").trim().toLowerCase();
    if (amount <= 0) { alert("Amount must be positive."); return; }

    if (text.startsWith('deposit ') || text.startsWith('income ')) {
        const description = text.split(' ').slice(1).join(' ');
        state.balance += amount;
        state.deposits.push({ amount, date: todayISO(), description });
    } else if (text.startsWith('goal ')) {
        const name = text.split(' ').slice(1).join(' ');
        if (name) state.goal = { name, amount }; else { alert("Please provide a goal name."); return; }
    } else {
        const description = text;
        const category = autoCategoryFromText(description) || "Uncategorized";
        state.balance -= amount;
        state.expenses.push({ category, amount, date: todayISO(), description });
    }
    input.value = "";
    updateUI();
}

document.getElementById("assetForm").addEventListener("submit", e => {
    e.preventDefault();
    const name = e.target[0].value.trim();
    const amount = parseFloat(e.target[1].value);
    if (name && amount > 0) {
        state.assets.push({ name, amount });
        updateUI();
    }
    e.target.reset();
});

document.getElementById("liabilityForm").addEventListener("submit", e => {
    e.preventDefault();
    const name = e.target[0].value.trim();
    const amount = parseFloat(e.target[1].value);
    if (name && amount > 0) {
        state.liabilities.push({ name, amount });
        updateUI();
    }
    e.target.reset();
});

document.getElementById("depositForm").addEventListener("submit", e => {
    e.preventDefault();
    const amount = parseFloat(e.target[0].value);
    const description = (e.target[1].value || "").trim();
    if (amount > 0) {
        state.balance += amount;
        state.deposits.push({ amount, date: todayISO(), description });
        updateUI();
    }
    e.target.reset();
});

const descInput = document.getElementById("expenseDesc");
const catInput = document.getElementById("expenseCategory");
descInput.addEventListener("input", () => {
    if (!catInput.value.trim()) {
        const guess = autoCategoryFromText(descInput.value);
        catInput.placeholder = guess ? `Auto: ${guess}` : "Category (auto if blank)";
    }
});

document.getElementById("expenseForm").addEventListener("submit", e => {
    e.preventDefault();
    const description = (document.getElementById("expenseDesc").value || "").trim();
    let category = (document.getElementById("expenseCategory").value || "").trim();
    const amount = parseFloat(document.getElementById("expenseAmount").value);
    const isRecurring = document.getElementById("recurringExpense").checked;

    if (!category) category = autoCategoryFromText(description) || "Uncategorized";
    if (amount > 0) {
        state.balance -= amount;
        state.expenses.push({ category, amount, date: todayISO(), description });
        if (isRecurring) {
            state.recurring.push({ category, amount, description });
            alert(`ğŸ” ${category} added as a recurring monthly expense.`);
        }
        updateUI();
    }
    e.target.reset();
    catInput.placeholder = "Category (auto if blank)";
});

goalForm.addEventListener("submit", e => {
    e.preventDefault();
    const name = e.target[0].value.trim();
    const amount = parseFloat(e.target[1].value);
    if (name && amount > 0) { state.goal = { name, amount }; updateUI(); }
    e.target.reset();
});

// ===== DATA MGMT =====
document.getElementById("resetBtn").addEventListener("click", () => {
    if (confirm("Are you sure you want to reset all data?")) {
        state = { balance: 0, deposits: [], expenses: [], recurring: [], goal: {name:"", amount:0}, assets:[], liabilities:[], netWorthHistory:[], lastAppliedMonth:null, lastBackupMonth:null };
        updateUI();
    }
});

document.getElementById("exportBtn").onclick = () => {
    const blob = new Blob([JSON.stringify(state)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "financeData.json"; a.click();
    URL.revokeObjectURL(url);
};

document.getElementById("importFile").addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = evt => {
        try {
            const incoming = JSON.parse(evt.target.result);
            state = { ...state, ...incoming };
            updateUI();
        } catch (error) {
            alert("Error importing file. It may be corrupted.");
        }
    };
    reader.readAsText(file);
});

// --- Animations ---
document.head.insertAdjacentHTML("beforeend", `<style>
.animate-fadeIn { animation: fadeIn 0.4s ease-in; }
@keyframes fadeIn { from {opacity:0; transform:translateY(6px);} to {opacity:1; transform:translateY(0);} }
</style>`);

// Init
applyRecurringExpenses();
updateUI();
</script>
</body>
</html>
